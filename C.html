import React, { useState, useEffect, useReducer, useRef, useCallback } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getFirestore, collection, writeBatch, query, onSnapshot, 
  serverTimestamp, limit, doc
} from 'firebase/firestore';
import { 
  getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged 
} from 'firebase/auth';

/**
 * --- Sovereign v86.8 Stable Loop ---
 * Fix: Eliminated UI freezing by removing metrics/health dependencies from the cycle.
 * Logic: Functional state updates for non-blocking concurrent throughput.
 */

const CORE_CONFIG = {
  BURST_COUNT: 3,
  CYCLE_INTERVAL: 30000, 
  MAX_RETRIES: 2,        
  MODELS: [
    { id: 'gemini-2.5-flash-preview-09-2025', label: 'Flash 2.5', tier: 1 },
    { id: 'gemini-1.5-pro', label: 'Pro 1.5', tier: 2 },
    { id: 'gemini-1.5-flash', label: 'Flash 1.5', tier: 3 }
  ],
  PROMPTS: [
    { id: 'refactor', label: 'Refactor', icon: 'üõ†Ô∏è', text: 'Act as a Principal Engineer. Aggressively refactor for performance.' },
    { id: 'security', label: 'Security', icon: 'üõ°Ô∏è', text: 'Act as a Security Auditor. Harden logic and sanitize inputs.' },
    { id: 'docs', label: 'Docs', icon: 'üìù', text: 'Act as a Technical Writer. Enhance JSDoc.' }
  ],
  APP_ID: typeof __app_id !== 'undefined' ? __app_id : 'emg-v86-sovereign'
};

const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const initialState = {
  isLive: false,
  isAcknowledged: false,
  isIndexed: false,
  burstMode: localStorage.getItem('emg_burst_v86') === 'true',
  status: 'IDLE',
  activePath: 'Ready',
  selectedModel: localStorage.getItem('emg_active_model_v86') || CORE_CONFIG.MODELS[0].id,
  selectedPrompt: localStorage.getItem('emg_prompt_v86') || 'refactor',
  temperature: parseFloat(localStorage.getItem('emg_temp_v86')) || 0.7,
  modelHealth: JSON.parse(localStorage.getItem('emg_health_v86')) || {}, 
  targetRepo: localStorage.getItem('emg_repo_v86') || '',
  logs: [],
  insights: [],
  metrics: { mutations: 0, skipped: 0, errors: 0, progress: 0 }
};

function reducer(state, action) {
  switch (action.type) {
    case 'SET_VAL': 
      const storageKey = `emg_${action.key}_v86`;
      if (['selectedModel', 'targetRepo', 'selectedPrompt', 'temperature', 'burstMode'].includes(action.key)) {
        localStorage.setItem(storageKey, action.value.toString());
      }
      return { ...state, [action.key]: action.value };
    case 'ACKNOWLEDGE': return { ...state, isAcknowledged: true };
    case 'TOGGLE': return { ...state, isLive: !state.isLive, status: !state.isLive ? 'STARTING' : 'IDLE' };
    case 'LOG': return { ...state, logs: [{ ...action.payload, id: Math.random() }, ...state.logs].slice(0, 50) };
    case 'SET_STATUS': return { ...state, status: action.value, activePath: action.path || state.activePath };
    case 'UPDATE_BATCH_METRICS': 
      const total = action.queueLength || 1;
      const nextMetrics = {
        mutations: state.metrics.mutations + action.m,
        skipped: state.metrics.skipped + action.s,
        errors: state.metrics.errors + action.e,
        progress: Math.round((action.cursor / total) * 100)
      };
      return { ...state, metrics: nextMetrics };
    case 'SET_INSIGHTS': return { ...state, insights: action.payload };
    case 'SET_MODEL_BLOCK':
      const newHealth = { ...state.modelHealth, [action.modelId]: { isBlocked: action.blocked, resetAt: action.resetAt } };
      localStorage.setItem('emg_health_v86', JSON.stringify(newHealth));
      return { ...state, modelHealth: newHealth };
    default: return state;
  }
}

export default function App() {
  const [state, dispatch] = useReducer(reducer, initialState);
  const [user, setUser] = useState(null);
  const [now, setNow] = useState(Date.now());
  const ghTokenRef = useRef('');
  const geminiKeyRef = useRef('');
  const isBusy = useRef(false);
  const queueRef = useRef(JSON.parse(localStorage.getItem('emg_queue_v86')) || []);
  const indexRef = useRef(parseInt(localStorage.getItem('emg_cursor_v86'), 10) || 0);

  const pushLog = useCallback((msg, type = 'info') => {
    dispatch({ type: 'LOG', payload: { msg, type, timestamp: new Date().toLocaleTimeString([], { hour12: false }) } });
  }, []);

  useEffect(() => {
    const t = setInterval(() => setNow(Date.now()), 1000);
    return () => clearInterval(t);
  }, []);

  useEffect(() => {
    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token).catch(() => signInAnonymously(auth));
      } else { await signInAnonymously(auth); }
    };
    initAuth();
    return onAuthStateChanged(auth, setUser);
  }, []);

  useEffect(() => {
    if (!user) return;
    const q = query(collection(db, 'artifacts', CORE_CONFIG.APP_ID, 'users', user.uid, 'insights'), limit(15));
    return onSnapshot(q, (snap) => {
      const data = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
      dispatch({ type: 'SET_INSIGHTS', payload: data });
    }, () => {});
  }, [user]);

  const processFile = async (path, repo, headers, geminiKey, modelId, promptText, temp) => {
    try {
      const encodedPath = path.split('/').map(s => encodeURIComponent(s)).join('/');
      const fRes = await fetch(`https://api.github.com/repos/${repo}/contents/${encodedPath}`, { headers });
      if (!fRes.ok) throw new Error(`GH ${fRes.status}`);
      
      const fData = await fRes.json();
      const raw = decodeURIComponent(escape(atob(fData.content)));
      
      const prompt = `${promptText}\nOutput code only.\n\nFile: ${path}\nSource:\n${raw}`;

      const aiRes = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelId}:generateContent?key=${geminiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { temperature: temp } })
      });

      if (aiRes.status === 429) return { path, status: 'RATE_LIMIT', wait: 60000 };
      if (!aiRes.ok) throw new Error(`AI ${aiRes.status}`);

      const aiData = await aiRes.json();
      let opt = aiData?.candidates?.[0]?.content?.parts?.[0]?.text;
      if (opt) opt = opt.replace(/^```[a-z]*\n/i, '').replace(/\n```$/i, '').trim();

      if (!opt || opt === raw || opt.length < 5) return { path, status: 'SKIPPED' };

      await fetch(`https://api.github.com/repos/${repo}/contents/${encodedPath}`, {
        method: 'PUT',
        headers,
        body: JSON.stringify({ message: `[v86.8] ${path}`, content: btoa(unescape(encodeURIComponent(opt))), sha: fData.sha })
      });

      return { path, status: 'MUTATED' };
    } catch (e) {
      return { path, status: 'ERROR', message: e.message };
    }
  };

  const runCycle = useCallback(async () => {
    if (!state.isLive || isBusy.current || !user || !state.isIndexed) return;

    // Check health of CURRENT model only
    const h = state.modelHealth[state.selectedModel];
    if (h?.isBlocked && h.resetAt > Date.now()) {
        const alt = CORE_CONFIG.MODELS.find(m => !state.modelHealth[m.id]?.isBlocked || state.modelHealth[m.id].resetAt < Date.now());
        if (alt) dispatch({ type: 'SET_VAL', key: 'selectedModel', value: alt.id });
        else pushLog("All models saturated", "info");
        return;
    }

    isBusy.current = true;
    const batchSize = state.burstMode ? CORE_CONFIG.BURST_COUNT : 1;
    const targets = queueRef.current.slice(indexRef.current, indexRef.current + batchSize);

    if (targets.length === 0) {
      pushLog("Vault Complete", "success");
      dispatch({ type: 'SET_VAL', key: 'isLive', value: false });
      isBusy.current = false;
      return;
    }

    try {
      dispatch({ type: 'SET_STATUS', value: 'CONCURRENT', path: `${targets.length} files` });
      const repo = state.targetRepo.replace(/^https?:\/\/github\.com\//, '').replace(/\/$/, '');
      const headers = { 'Authorization': `token ${ghTokenRef.current}`, 'Accept': 'application/vnd.github.v3+json' };
      const promptText = CORE_CONFIG.PROMPTS.find(p => p.id === state.selectedPrompt).text;

      const results = await Promise.all(targets.map(p => 
        processFile(p, repo, headers, geminiKeyRef.current, state.selectedModel, promptText, state.temperature)
      ));

      const batch = writeBatch(db);
      let m = 0, s = 0, e = 0;

      results.forEach(res => {
        if (res.status === 'RATE_LIMIT') {
          dispatch({ type: 'SET_MODEL_BLOCK', modelId: state.selectedModel, blocked: true, resetAt: Date.now() + res.wait });
          e++;
        } else if (res.status === 'MUTATED') {
          m++;
          batch.set(doc(collection(db, 'artifacts', CORE_CONFIG.APP_ID, 'users', user.uid, 'insights')), { filePath: res.path, timestamp: serverTimestamp() });
          pushLog(`‚úì ${res.path.split('/').pop()}`, "success");
        } else if (res.status === 'ERROR') {
          e++;
          pushLog(`! ${res.path.split('/').pop()}: ${res.message}`, "error");
        } else s++;
      });

      if (m > 0) await batch.commit();

      indexRef.current += targets.length;
      localStorage.setItem('emg_cursor_v86', indexRef.current.toString());
      
      dispatch({ 
        type: 'UPDATE_BATCH_METRICS', 
        m, s, e, 
        cursor: indexRef.current, 
        queueLength: queueRef.current.length 
      });

    } catch (err) {
      pushLog("Loop Error", "error");
    } finally {
      isBusy.current = false;
      dispatch({ type: 'SET_STATUS', value: 'IDLE' });
    }
  }, [state.isLive, state.targetRepo, state.selectedModel, state.burstMode, state.isIndexed, state.selectedPrompt, state.temperature, user, state.modelHealth, pushLog]);

  useEffect(() => {
    if (!state.isLive) return;
    const t = setInterval(runCycle, CORE_CONFIG.CYCLE_INTERVAL);
    runCycle();
    return () => clearInterval(t);
  }, [state.isLive, runCycle]);

  const startIndexing = async () => {
    try {
      dispatch({ type: 'SET_STATUS', value: 'INDEXING' });
      const repo = state.targetRepo.replace(/^https?:\/\/github\.com\//, '').replace(/\/$/, '');
      const headers = { 'Authorization': `token ${ghTokenRef.current}`, 'Accept': 'application/vnd.github.v3+json' };
      const r = await fetch(`https://api.github.com/repos/${repo}`, { headers });
      const rData = await r.json();
      const t = await fetch(`https://api.github.com/repos/${repo}/git/trees/${rData.default_branch}?recursive=1`, { headers });
      const tData = await t.json();
      
      const files = (tData?.tree || []).filter(f => f.type === 'blob' && f.path.match(/\.(js|jsx|ts|tsx|py|html|css|md|txt)$/i)).map(f => f.path);
      queueRef.current = files;
      localStorage.setItem('emg_queue_v86', JSON.stringify(files));
      indexRef.current = 0;
      localStorage.setItem('emg_cursor_v86', '0');
      dispatch({ type: 'SET_VAL', key: 'isIndexed', value: true });
      pushLog(`Vault: ${files.length} artifacts`, "success");
    } catch (e) { pushLog("Index Fail", "error"); }
    finally { dispatch({ type: 'SET_STATUS', value: 'IDLE' }); }
  };

  if (!state.isAcknowledged) {
    return (
      <div className="min-h-screen bg-black flex items-center justify-center p-8 text-white">
        <div className="max-w-md w-full p-12 rounded-[4rem] bg-zinc-900/40 border border-white/10 text-center backdrop-blur-3xl shadow-2xl">
          <div className="text-6xl mb-10">üõ°Ô∏è</div>
          <h1 className="text-3xl font-black uppercase italic tracking-tighter mb-4">Sovereign <span className="text-indigo-500">v86.8</span></h1>
          <p className="text-[10px] text-zinc-500 uppercase tracking-[0.4em] mb-12">Stable Loop Architecture</p>
          <button onClick={() => dispatch({ type: 'ACKNOWLEDGE' })} className="w-full py-6 bg-indigo-600 rounded-3xl font-black uppercase text-xs tracking-widest hover:bg-indigo-500 transition-all shadow-lg shadow-indigo-500/20">Boot OS</button>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-[#020202] text-zinc-400 p-4 md:p-10 font-sans selection:bg-indigo-500/30">
      <div className="max-w-7xl mx-auto space-y-6">
        
        <header className="p-10 rounded-[4rem] bg-zinc-900/20 border border-white/5 flex flex-col lg:flex-row items-center justify-between gap-10 backdrop-blur-3xl">
          <div className="flex items-center gap-8">
            <div className={`w-20 h-20 rounded-[2.5rem] flex items-center justify-center text-4xl border-2 transition-all duration-700 ${state.isLive ? 'bg-indigo-500/10 text-indigo-500 border-indigo-500/20 shadow-[0_0_50px_rgba(99,102,241,0.2)]' : 'bg-zinc-800/10 text-zinc-600 border-white/5'}`}>
              {state.isLive ? 'üåÄ' : 'üí§'}
            </div>
            <div>
              <h1 className="text-2xl md:text-3xl font-black text-white uppercase italic tracking-tighter">Sovereign <span className="text-indigo-500">Stability</span></h1>
              <div className="flex items-center gap-4 mt-2">
                <span className={`px-3 py-1 rounded-full text-[9px] font-black uppercase tracking-widest ${state.isLive ? 'bg-indigo-600 text-white' : 'bg-zinc-800 text-zinc-500'}`}>{state.status}</span>
                <span className="text-[9px] font-mono text-zinc-600 uppercase tracking-widest truncate max-w-[200px]">{state.activePath}</span>
              </div>
            </div>
          </div>

          <div className="flex flex-wrap items-center justify-center gap-5">
            <button onClick={() => dispatch({ type: 'SET_VAL', key: 'burstMode', value: !state.burstMode })} className={`px-6 py-3 rounded-full text-[9px] font-black uppercase border-2 transition-all ${state.burstMode ? 'bg-indigo-600 border-indigo-400 text-white shadow-lg shadow-indigo-500/20' : 'border-zinc-800 text-zinc-600'}`}>Burst: {state.burstMode ? 'ON' : 'OFF'}</button>
            <button 
              onClick={() => state.isLive ? dispatch({ type: 'TOGGLE' }) : (state.isIndexed ? dispatch({ type: 'TOGGLE' }) : startIndexing())}
              className={`px-12 py-6 rounded-3xl text-[10px] font-black uppercase tracking-widest transition-all ${state.isLive ? 'bg-zinc-950 text-red-500 border border-red-500/20' : state.isIndexed ? 'bg-indigo-600 text-white shadow-2xl shadow-indigo-500/30 hover:scale-105' : 'bg-white text-black hover:bg-zinc-100'}`}
            >
              {state.isLive ? 'Suspend' : state.isIndexed ? 'Engage' : 'Index'}
            </button>
          </div>
        </header>

        <div className="grid grid-cols-1 lg:grid-cols-12 gap-6">
          <div className="lg:col-span-4 space-y-6">
            <div className="p-10 bg-zinc-900/10 border border-white/5 rounded-[4rem] space-y-8">
              <div className="space-y-4">
                <label className="text-[10px] font-black text-zinc-600 uppercase tracking-widest ml-1">Pattern</label>
                <div className="grid grid-cols-3 gap-3">
                  {CORE_CONFIG.PROMPTS.map(p => (
                    <button key={p.id} onClick={() => dispatch({ type: 'SET_VAL', key: 'selectedPrompt', value: p.id })} className={`py-5 rounded-3xl flex flex-col items-center gap-2 border transition-all ${state.selectedPrompt === p.id ? 'bg-indigo-600/10 border-indigo-500/50 text-white' : 'bg-black/40 border-white/5 text-zinc-700'}`}>
                      <span className="text-2xl">{p.icon}</span>
                      <span className="text-[8px] font-black uppercase">{p.label}</span>
                    </button>
                  ))}
                </div>
              </div>

              {[
                { id: 'targetRepo', label: 'Vault', ph: 'user/repo' },
                { id: 'token', label: 'GH Token', ph: 'ghp_****' },
                { id: 'apiKey', label: 'Gemini', ph: 'aiza_****' }
              ].map((f) => (
                <div key={f.id} className="space-y-3">
                  <label className="text-[9px] font-black text-zinc-600 uppercase tracking-widest ml-1">{f.label}</label>
                  <input type={f.id === 'targetRepo' ? 'text' : 'password'} value={f.id === 'targetRepo' ? state.targetRepo : undefined} onChange={e => f.id === 'targetRepo' ? dispatch({ type: 'SET_VAL', key: 'targetRepo', value: e.target.value }) : (f.id === 'token' ? ghTokenRef.current = e.target.value : geminiKeyRef.current = e.target.value)} className="w-full bg-black/60 border border-white/5 rounded-3xl p-5 text-xs outline-none text-white focus:border-indigo-500/40 transition-all placeholder:text-zinc-800" placeholder={f.ph} />
                </div>
              ))}
            </div>

            <div className="p-10 bg-zinc-900/10 border border-white/5 rounded-[4rem] space-y-5">
                <h2 className="text-[10px] font-black uppercase tracking-widest text-zinc-600">Model Health</h2>
                {CORE_CONFIG.MODELS.map(m => {
                    const h = state.modelHealth[m.id];
                    const isBlocked = h?.isBlocked && h.resetAt > now;
                    return (
                        <div key={m.id} onClick={() => dispatch({ type: 'SET_VAL', key: 'selectedModel', value: m.id })} className={`p-5 rounded-3xl border flex items-center justify-between cursor-pointer transition-all ${state.selectedModel === m.id ? 'bg-indigo-500/10 border-indigo-500/40 text-white' : 'bg-black/40 border-white/5 text-zinc-700'}`}>
                            <span className="text-[10px] font-black uppercase">{m.label}</span>
                            {isBlocked && <span className="text-[10px] font-mono text-indigo-400 animate-pulse">{Math.ceil((h.resetAt - now)/1000)}s</span>}
                        </div>
                    );
                })}
            </div>
          </div>

          <div className="lg:col-span-8 space-y-6">
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                {[
                    { label: 'Mutations', val: state.metrics.mutations, color: 'text-indigo-500' },
                    { label: 'Queue', val: queueRef.current.length, color: 'text-zinc-600' },
                    { label: 'Status', val: `${state.metrics.progress}%`, color: 'text-white' },
                    { label: 'Errors', val: state.metrics.errors, color: 'text-red-900' }
                ].map((s, i) => (
                    <div key={i} className="p-8 bg-zinc-900/10 border border-white/5 rounded-[3rem] text-center">
                        <div className={`text-3xl font-black mb-1 ${s.color}`}>{s.val}</div>
                        <div className="text-[9px] font-black uppercase tracking-widest text-zinc-600">{s.label}</div>
                    </div>
                ))}
            </div>

            <div className="h-[450px] bg-black border border-white/5 rounded-[4rem] p-12 flex flex-col">
              <div className="flex justify-between items-center mb-10">
                <span className="text-[11px] font-black text-white uppercase tracking-[0.5em] flex items-center gap-4">Telemetry Stream</span>
                <span className="text-[9px] text-zinc-800 font-mono font-black uppercase">v86.8.0</span>
              </div>
              <div className="flex-1 overflow-y-auto space-y-3 font-mono text-[10px] scrollbar-hide pr-4">
                {state.logs.map(l => (
                  <div key={l.id} className="flex gap-8 py-2 border-b border-white/5 items-start">
                    <span className="text-zinc-800 font-black tabular-nums">{l.timestamp}</span>
                    <span className={l.type === 'error' ? 'text-red-500' : l.type === 'success' ? 'text-indigo-400' : 'text-zinc-600'}>
                      {l.msg}
                    </span>
                  </div>
                ))}
              </div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              {state.insights.map(i => (
                <div key={i.id} className="p-6 bg-zinc-900/10 border border-white/5 rounded-[2.5rem] flex flex-col justify-between h-36">
                  <div className="min-w-0">
                    <div className="text-[10px] font-black text-indigo-500 truncate uppercase tracking-tighter">{i.filePath?.split('/').pop()}</div>
                    <div className="text-[8px] text-zinc-800 truncate mt-2 font-mono">{i.filePath}</div>
                  </div>
                  <div className="flex justify-between items-center pt-5 border-t border-white/5">
                    <span className="text-[8px] font-black text-zinc-700 bg-zinc-950 px-3 py-1 rounded-full uppercase">Stored</span>
                    <span className="text-[8px] text-zinc-800 font-mono">{i.timestamp?.seconds ? new Date(i.timestamp.seconds * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit'}) : '...'}</span>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      </div>
      
      <style>{`
        .scrollbar-hide::-webkit-scrollbar { display: none; }
      `}</style>
    </div>
  );
}
